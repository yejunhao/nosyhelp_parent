import org.activiti.engine.ProcessEngine;
import org.activiti.engine.impl.asyncexecutor.DefaultAsyncJobExecutor; // 引入默认执行器
import org.activiti.spring.SpringProcessEngineConfiguration;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.PlatformTransactionManager;

import javax.sql.DataSource;

@Configuration
public class ItUserSidecarConfig {

    private static final String IT_TENANT_KEY = "HK-HBAP-IT-DEFAULT";
    // 给影子引擎起个独一无二的名字，方便日志排查
    private static final String SIDECAR_ENGINE_NAME = "sidecar-IT-engine";

    // ... (保留之前的 itRealDataSource 和 itRealTransactionManager 代码) ...

    @Bean(name = "itSidecarProcessEngine")
    public ProcessEngine itSidecarProcessEngine(
            @Qualifier("itRealDataSource") DataSource itRealDataSource,
            @Qualifier("itRealTransactionManager") PlatformTransactionManager transactionManager) {

        SpringProcessEngineConfiguration config = new SpringProcessEngineConfiguration();

        // 1. 基础连接
        config.setDataSource(itRealDataSource);
        config.setTransactionManager(transactionManager);
        config.setDatabaseSchemaUpdate("true");

        // 2. 【关键修正】显式配置并启动 AsyncExecutor
        DefaultAsyncJobExecutor asyncExecutor = new DefaultAsyncJobExecutor();
        
        // 设置扫描间隔 (例如 3秒扫一次，方便你测试观察)
        asyncExecutor.setDefaultAsyncJobAcquireWaitTimeInMillis(3000);
        // 设置线程池里的线程名称前缀，让你在日志里一眼看到它！
        asyncExecutor.setThreadPoolNamingPattern("sidecar-IT-worker-");
        
        config.setAsyncExecutor(asyncExecutor);
        config.setAsyncExecutorActivate(true); // 告诉引擎启动时同时也启动这个Executor

        // 3. 【关键修正】强制设置引擎名称
        // 如果这里不设，或者设重复了，Activiti 内部注册时会打架，导致 execution 获取混乱
        config.setProcessEngineName(SIDECAR_ENGINE_NAME);

        ProcessEngine engine = config.buildProcessEngine();
        System.out.println(">>> 影子引擎 [ " + SIDECAR_ENGINE_NAME + " ] 强制启动完成 <<<");
        return engine;
    }
}
